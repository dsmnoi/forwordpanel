flowCount=(`iptables -n -v -L -t filter -x | grep @remoteIp |wc -l`);for((i=1;i<=$flowCount;i++));do iptables -D FORWARD -s @remoteIp;done;sed -n '/^net.ipv4.ip_forward=1/'p /etc/sysctl.conf | grep -q "net.ipv4.ip_forward=1";if [ $? -ne 0 ]; then echo -e "net.ipv4.ip_forward=1" >> /etc/sysctl.conf && sysctl -p;fi;arr1=(`iptables -L FORWARD -n  --line-number |grep "REJECT"|grep "0.0.0.0/0"|sort -r|awk '{print $1,$2,$5}'|tr " " ":"|tr "\n" " "`);for cell in ${arr1[@]};do arr2=(`echo $cell|tr ":" " "`);index=${arr2[0]};echo 删除禁止FOWARD的规则$index;iptables -D FORWARD $index;done;iptables --policy FORWARD ACCEPT;local=$(ip -o -4 addr list | grep -Ev '\s(docker|lo)' | awk '{print $4}' | cut -d/ -f1 | grep -Ev '(^127\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}$)|(^10\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}$)|(^172\.1[6-9]{1}[0-9]{0,1}\.[0-9]{1,3}\.[0-9]{1,3}$)|(^172\.2[0-9]{1}[0-9]{0,1}\.[0-9]{1,3}\.[0-9]{1,3}$)|(^172\.3[0-1]{1}[0-9]{0,1}\.[0-9]{1,3}\.[0-9]{1,3}$)|(^192\.168\.[0-9]{1,3}\.[0-9]{1,3}$)');if [ "x${local}" = "x" ]; then local=$(ip -o -4 addr list | grep -Ev '\s(docker|lo)' | awk '{print $4}' | cut -d/ -f1 );fi;arr1=(`iptables -L PREROUTING -n -t nat --line-number |grep DNAT|grep "dpt:@localport "|sort -r|awk '{print $1,$3,$9}'|tr " " ":"|tr "\n" " "`);for cell in ${arr1[@]};  do arr2=(`echo $cell|tr ":" " "`);index=${arr2[0]};proto=${arr2[1]};targetIP=${arr2[3]};targetPort=${arr2[4]};iptables -t nat  -D PREROUTING $index;toRmIndexs=(`iptables -L POSTROUTING -n -t nat --line-number|grep $targetIP|grep $targetPort|grep $proto|awk  '{print $1}'|sort -r|tr "\n" " "`);for cell1 in ${toRmIndexs[@]};do iptables -t nat  -D POSTROUTING $cell1;done;done;iptables -t nat -A PREROUTING -p tcp --dport @localport -j DNAT --to-destination @remoteIp:@remoteport;iptables -t nat -A PREROUTING -p udp --dport @localport -j DNAT --to-destination @remoteIp:@remoteport;iptables -t nat -A POSTROUTING -p tcp -d @remoteIp --dport @remoteport -j SNAT --to-source $local;iptables -t nat -A POSTROUTING -p udp -d @remoteIp --dport @remoteport -j SNAT --to-source $local;flow_collect=$(iptables -n -v -L -t filter -x | grep @remoteIp | awk '{print $2}');if [ "x${flow_collect}" = "x" ]; then iptables -I FORWARD -s @remoteIp; fi
                                                                               fi
